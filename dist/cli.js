#!/usr/bin/env node
(()=>{var e={831:(e,t,r)=>{const a=r(981),{ENOENT:o}=r(373).code,s={jsENOENT:o.code,jsonPathNotFound:"JsonPathNotFound",errorAndErrorsMutuallyExclusive:"ErrorErrorsMutuallyExclusive",parseError:"ParseError",validation:"Validation"};class n{static create(e){const{code:t,message:r,path:o,cause:i}=e,p=t||e.type||s.validation,l={message:r};return s.validation===p||s.errorAndErrorsMutuallyExclusive===p?a(l,e):(o&&a(l,{params:{path:o}}),i&&a(l,i)),new n(p,l)}constructor(e,t={}){Object.assign(this,{type:e,...t})}}e.exports={ApplicationError:n,ErrorType:s}},339:(e,t,r)=>{const a=r(156).version,o=r(304),{validateFile:s,validateExample:n,validateExamplesByMap:i}=r(579),p="true"===process.env.OPENAPI_EXAMPLES_VALIDATOR_TESTS;o.version(a).arguments("<filepath>").description("Validate embedded examples in OpenAPI-specs (JSON and YAML supported).\n  To validate external examples, use the `-s` and `-e` option.\n  To pass a mapping-file, to validate multiple external examples, use the `-m` option.").option("-s, --schema-jsonpath <schema-jsonpath>","Path to OpenAPI-schema, to validate the example file against").option("-e, --example-filepath <example-filepath>","file path to example file, to be validated").option("-m, --mapping-filepath <mapping-filepath>","file path to map, containing schema-paths as key and the file-path(s) to examples as value. If wildcards are used, the parameter has to be put in quotes.").option("-c, --cwd-to-mapping-file","changes to the directory of the mapping-file, before resolving the example's paths. Use this option, if your mapping-files use relative paths for the examples").option("-n, --no-additional-properties","don't allow properties that are not described in the schema").option("-r, --all-properties-required","make all the properties in the schema required").option("-o, --ignore-formats <ignored-formats...>",'Datatype formats to ignore (to prevent "unknown format" message in the error-console.)').action((async function(e,t){const{schemaJsonpath:r,exampleFilepath:a,mappingFilepath:o,cwdToMappingFile:l,allPropertiesRequired:c}=t,u=!t.additionalProperties,d=function(e){return null!=e&&Array.isArray(e)?1!==e.length||-1===e[0].indexOf("\n")?e:e[0].split("\n").filter((e=>!e.match(/^\s*$/))):e}(t.ignoreFormats);let m;o?(console.log("Validating with mapping file"),m=await i(e,o,{cwdToMappingFile:l,noAdditionalProperties:u,ignoreFormats:d,allPropertiesRequired:c})):r&&a?(console.log("Validating single external example"),m=await n(e,r,a,{noAdditionalProperties:u,ignoreFormats:d,allPropertiesRequired:c})):(console.log("Validating examples"),m=await s(e,{noAdditionalProperties:u,ignoreFormats:d,allPropertiesRequired:c})),function(e){const t=p;if(function(e){const{schemasWithExamples:t,examplesWithoutSchema:r,examplesTotal:a,matchingFilePathsMapping:o}=e,s=[`Schemas with examples found: ${t}`,`Examples without schema found: ${r}`,`Total examples found: ${a}`];null!=o&&s.push(`Matching mapping files found: ${o}`),process.stdout.write(`${s.join("\n")}\n`)}(e.statistics),e.valid)return process.stdout.write("\nNo errors found.\n\n"),void(!t&&process.exit(0));process.stdout.write("\nErrors found.\n\n"),process.stderr.write(JSON.stringify(e.errors,null,"    ")),!t&&process.exit(1)}(m)})),o.on("--help",(()=>{console.log("\n\n  Example for external example-file:\n"),console.log("    $ openapi-examples-validator -s $.paths./.get.responses.200.schema -e example.json openapi-spec.json\n\n")})),e.exports=o.parseAsync(process.argv)},457:e=>{e.exports={parent:"parent",parentProperty:"parentProperty",path:"path",pointer:"pointer",value:"value"}},884:(e,t,r)=>{const a=r(442),o=r(955),s=/^3\./;e.exports={getImplementation:function(e){return"string"==typeof e.swagger?a:e.openapi&&e.openapi.match(s)?o:null}}},305:(e,t,r)=>{const{applyCallbackToAllObjectModels:a}=r(818);e.exports={setAllPropertiesRequired:function(e,t=[]){a(e,t,(()=>e=>{e.hasOwnProperty("properties")&&(e.required=Object.keys(e.properties))}))}}},818:(e,t,r)=>{const{JSONPath:a}=r(166),o=r(457);function s(e,t,r=o.path,s){return a({json:e,path:t,flatten:!0,resultType:r,callback:s})}e.exports={applyCallbackToAllObjectModels:function(e,t,r){const a=new Set;s(e,"$..schema..").forEach((e=>{(function(e){if(!e.match(/\['properties']$/))return;const t=e.match(/(?<!\['properties'])(\['properties']\['properties'])+$/);return!t||t.length%2!=0})(e)||a.add(e)})),function(e,t,r){r.forEach((r=>{s(e,r).forEach((e=>{for(const r of t)r.startsWith(e)&&t.delete(r)}))}))}(e,a,t);for(const t of a){const a=r(t);s(e,t,o.value,((e,t,r)=>{var o;("object"===(o=e).type||o.properties)&&a(e,t,r)}))}}}},257:(e,t,r)=>{const{applyCallbackToAllObjectModels:a}=r(818);e.exports={setNoAdditionalProperties:function(e,t=[]){const r=new RegExp("(?<!\\['properties'\\])\\['(?:"+o.join("|")+")'\\]");a(e,t,(e=>t=>{r.test(e)?console.warn(`"additionalProperties" flag not set for ${e} because it has a parent with a JSON-schema combiner keyword.`):o.some((e=>t.hasOwnProperty(e)))?console.warn(`"additionalProperties" flag not set for ${e} because it contains JSON-schema combiner keyword.`):t.hasOwnProperty("additionalProperties")||(t.additionalProperties=!1)}))}};const o=["oneOf","allOf","anyOf","not"]},442:(e,t,r)=>{const{JSONPath:a}=r(166),o=r(548),{setAllPropertiesRequired:s}=r(305),{setNoAdditionalProperties:n}=r(257);function i(){return["$..examples.application/json"]}e.exports={buildValidationMap:function(e){return e.reduce(((e,t)=>{const r=function(e){const t=a.toPathArray(e).slice(),r=t.lastIndexOf("examples");return t.splice(r,t.length-r,"schema"),a.toPathString(t)}(t);return e[r]=(e[r]||new Set).add(t),e}),{})},escapeExampleName:function(e){return e},getJsonPathsToExamples:i,prepare:function(e,{noAdditionalProperties:t,allPropertiesRequired:r}={}){const a=o(e);return t&&n(a,["$..examples.application/json"]),r&&s(a,["$..examples.application/json"]),a},unescapeExampleNames:function(e){return e}}},955:(e,t,r)=>{const{JSONPath:a}=r(166),o=r(548),{ApplicationError:s,ErrorType:n}=r(831),{setAllPropertiesRequired:i}=r(305),{setNoAdditionalProperties:p}=r(257),l="single",c="multi";function u(){return["$..responses..content.application/json.example","$..responses..content.application/json.examples.*.value","$..parameters..example","$..parameters..examples.*.value","$..requestBody.content.application/json.example","$..requestBody.content.application/json.examples.*.value"]}e.exports={buildValidationMap:function(e){const t=new Map;return e.reduce(((e,r)=>{const{pathSchemaAsArray:o,exampleType:i}=function(e){const t=a.toPathArray(e).slice(),r=t.lastIndexOf("example"),o=r>-1?l:c,s=o===l?r:t.lastIndexOf("examples");return t.splice(s,t.length-s,"schema"),{exampleType:o,pathSchemaAsArray:t}}(r),p=a.toPathString(o),u=t.get(p);return u&&u!==i&&function(e){const t=e.slice(0,e.length-1);throw s.create({type:n.errorAndErrorsMutuallyExclusive,message:'Properties "error" and "errors" are mutually exclusive',params:{pathContext:a.toPointer(t)}})}(o),t.set(p,i),e[p]=(e[p]||new Set).add(r),e}),{})},escapeExampleName:function(e){return e.replace(/\['examples'\]\['(.*)\]\['value'\]$/,"['examples']['`$1]['value']")},getJsonPathsToExamples:u,prepare:function(e,{noAdditionalProperties:t,allPropertiesRequired:r}={}){const a=o(e);return t&&p(a,["$..responses..content.application/json.example","$..responses..content.application/json.examples.*.value","$..parameters..example","$..parameters..examples.*.value","$..requestBody.content.application/json.example","$..requestBody.content.application/json.examples.*.value"]),r&&i(a,["$..responses..content.application/json.example","$..responses..content.application/json.examples.*.value","$..parameters..example","$..parameters..examples.*.value","$..requestBody.content.application/json.example","$..requestBody.content.application/json.examples.*.value"]),a},unescapeExampleNames:function(e){return e&&e.replace(/\/examples\/`(.*)\/value$/,"/examples/$1/value")}}},579:(e,t,r)=>{const a=r(981),o=r(760),s=r(574),n=r(147),i=r(17),p=r(230),l=r(66),{JSONPath:c}=r(166),u=r(432),{createError:d}=r(373).custom,m=r(457),{getValidatorFactory:h,compileValidate:f}=r(239),x=r(884),{ApplicationError:g,ErrorType:y}=r(831),{createValidationResponse:v,dereferenceJsonSchema:P}=r(903),b=Symbol("internal"),j="schemasWithExamples",w=["yaml","yml"],E=d(y.jsonPathNotFound);async function $(e,{noAdditionalProperties:t,ignoreFormats:r,allPropertiesRequired:a}={}){const o=x.getImplementation(e);e=await u.dereference(e),e=o.prepare(e,{noAdditionalProperties:t,allPropertiesRequired:a});let s=o.getJsonPathsToExamples().reduce(((t,r)=>t.concat(function(e,t){return c({json:e,path:t,resultType:m.path})}(e,r))),[]).map(o.escapeExampleName);return function({impl:e},t,r,{ignoreFormats:a}){const o=S(),s={valid:!0,statistics:o,errors:[]},n=k(r,{ignoreFormats:a});let i;try{i=e.buildValidationMap(t)}catch(e){if(!(e instanceof g))throw e;return s.valid=!1,s.errors.push(e),s}return Object.keys(i).forEach((e=>{!function({openapiSpec:e,createValidator:t,pathSchema:r,validationMap:a,statistics:o,validationResult:s}){const n=s.errors;a[r].forEach((a=>{const i=F(a,e),p=T(r,e,!0),l=N({createValidator:t,schema:p,example:i,statistics:o}).map((e=>(e.examplePath=c.toPointer(c.toPathArray(a)),e)));l.length&&(s.valid=!1,n.splice(n.length-1,0,...l))}))}({openapiSpec:r,createValidator:n,pathSchema:e,validationMap:i,statistics:o,validationResult:s})})),s.errors.forEach((t=>{t.examplePath=e.unescapeExampleNames(t.examplePath)})),s}({impl:o},s,e,{ignoreFormats:r})}async function A(e){const t=function(e){const t=e.split(".").pop();return w.includes(t)}(e);let r;if(t)try{r=l.parse(n.readFileSync(e,"utf-8"))}catch(e){const{name:t,message:r}=e;throw new g(y.parseError,{message:`${t}: ${r}`})}else r=JSON.parse(n.readFileSync(e,"utf-8"));return await P(e,r)}function q(e){const t=S(),r=e(t);return v({errors:r,statistics:t})}function O(e,t,r,{cwdToMappingFile:a=!1,dirPathMapExternalExamples:l,ignoreFormats:c}){return s(Object.entries(t),(([t,u])=>{let d=null;try{d=T(t,e)}catch(e){return g.create(e)}return s(o([u]),(t=>{let o=[];try{const e=a?i.join(l,t):t,r=p.sync(e);if(0===r.length)return[g.create({type:y.jsENOENT,message:`No such file or directory: '${e}'`,path:e})];for(const e of r)o.push({path:i.normalize(e),content:JSON.parse(n.readFileSync(e,"utf-8"))})}catch(e){return[g.create(e)]}return s(o,(t=>N({createValidator:k(e,{ignoreFormats:c}),schema:d,example:t.content,statistics:r,filePathExample:t.path})))}))}))}function S(){const e={[b]:{[j]:new Set},examplesTotal:0,examplesWithoutSchema:0};return Object.defineProperty(e,j,{enumerable:!0,get:()=>e[b][j].size}),e}function F(e,t){return c({json:t,path:e,flatten:!0,wrap:!1,resultType:m.value})}function N({createValidator:e,schema:t,example:r,statistics:a,filePathExample:o}){const s=[];if(a.examplesTotal++,!t)return a.examplesWithoutSchema++,s;a[b][j].add(t);const n=f(e(),t);return n(r)?s:s.concat(...n.errors.map(g.create)).map((e=>o?(e.exampleFilePath=o,e):e))}function k(e,{ignoreFormats:t}){return h(e,{schemaId:"auto",discriminator:!0,strict:!1,allErrors:!0,formats:t&&t.reduce(((e,t)=>(e[t]=()=>!0,e)),{})})}function T(e,t,r=!1){const a=F(e,t);if(!r&&!a)throw new E(`Path to schema can't be found: '${e}'`,{params:{path:e}});return a}e.exports={default:$,validateFile:async function(e,{noAdditionalProperties:t,ignoreFormats:r,allPropertiesRequired:a}={}){let o=null;try{o=await A(e)}catch(e){return v({errors:[g.create(e)]})}return $(o,{noAdditionalProperties:t,ignoreFormats:r,allPropertiesRequired:a})},validateExample:async function(e,t,r,{noAdditionalProperties:a,ignoreFormats:o,allPropertiesRequired:s}={}){let i=null,p=null,l=null;try{i=JSON.parse(n.readFileSync(r,"utf-8")),l=await A(e),l=x.getImplementation(l).prepare(l,{noAdditionalProperties:a,allPropertiesRequired:s}),p=T(t,l)}catch(e){return v({errors:[g.create(e)]})}return q((e=>N({createValidator:k(l,{ignoreFormats:o}),schema:p,example:i,statistics:e,filePathExample:r})))},validateExamplesByMap:async function(e,t,{cwdToMappingFile:r,noAdditionalProperties:o,ignoreFormats:s,allPropertiesRequired:l}={}){let c=0;const u=p.sync(t,{nonull:!0});let d=[];for(const t of u){let a=null,p=null;try{a=JSON.parse(n.readFileSync(t,"utf-8")),p=await A(e),p=x.getImplementation(p).prepare(p,{noAdditionalProperties:o,allPropertiesRequired:l})}catch(e){d.push(v({errors:[g.create(e)]}));continue}c++,d.push(q((e=>O(p,a,e,{cwdToMappingFile:r,dirPathMapExternalExamples:i.dirname(t),ignoreFormats:s}).map((e=>Object.assign(e,{mapFilePath:i.normalize(t)}))))))}return a(d.reduce(((e,t)=>{return e?(a=t,v({errors:(r=e).errors.concat(a.errors),statistics:Object.entries(r.statistics).reduce(((e,[t,o])=>j===t?([r,a].forEach((t=>{const r=t.statistics[b][j].values();for(let t of r)e[b][j].add(t)})),e):(e[t]=o+a.statistics[t],e)),S())})):t;var r,a}),null),{statistics:{matchingFilePathsMapping:c}})}}},903:(e,t,r)=>{const a=r(17),o=r(432);e.exports={createValidationResponse:function({errors:e,statistics:t={}}){return{valid:!e.length,statistics:t,errors:e}},dereferenceJsonSchema:async function(e,t){const r=process.cwd();process.chdir(a.dirname(e));const s=await o.dereference(t);return process.chdir(r),s}}},239:(e,t,r)=>{const{JSONPath:a}=r(166),o=r(125),s=r(643),n=r(638),i="$..$ref",p="https://www.npmjs.com/package/openapi-examples-validator/defs.json";e.exports={getValidatorFactory:function(e,t){const r=function(e){const t={$id:p};return a({path:i,json:e,callback(r){if(!r.startsWith("#"))return;const a=r.substring(1),s=o.get(e,a);o.set(t,a,s)}}),t}(e);return()=>{const e=new s(t);return n(e),e.addSchema(r),e}},compileValidate:function(e,t){const r=function(e,t){const r=Object.assign({},e);return r.$id="https://www.npmjs.com/package/openapi-examples-validator/schema.json",r}(t);let o;a({path:i,json:r,callback(e,t,r){e.startsWith("#")&&(r.parent[r.parentProperty]=`${p}${e}`)}});try{o=e.compile(r)}catch(e){o=()=>{},o.errors=[e]}return o}}},156:e=>{e.exports={name:"openapi-examples-validator",version:"5.0.0",description:"Validates embedded examples in OpenAPI-JSONs",main:"dist/index.js",engines:{node:">=16"},bin:{"openapi-examples-validator":"dist/cli.js"},"standard-version":{scripts:{postchangelog:"npm run release:create-dockerfile && npm run release:stage-artifacts"}},scripts:{"start-dev":"babel-node src/cli",build:"npm run build:clean && npm run build:webpack","build:clean":"rimraf dist","build:webpack":"webpack --bail --progress --profile --mode production --config ./webpack/config.babel.js",coverage:'rimraf ./coverage && nyc --reporter=lcov --reporter=text -x "dist/**/*" -x "test/**/*.js" npm test',coveralls:"cat ./coverage/lcov.info | coveralls",test:"npm run build && npm run test:mocha","test-mutations":"stryker run","test:mocha":'mocha --require "./test/util/setup-tests" --recursive "./test/specs/**/*.js"',release:"npm run build && standard-version -a","release:create-dockerfile":"npm run build && node etc/src/build-dockerfile.js","release:stage-artifacts":"git add dist/*"},repository:{type:"git",url:"git+https://github.com/codekie/openapi-examples-validator.git"},keywords:["swagger","openapi","json","validate","examples"],author:"Josua Amann",license:"MIT",bugs:{url:"https://github.com/codekie/openapi-examples-validator/issues"},homepage:"https://github.com/codekie/openapi-examples-validator#readme",devDependencies:{"@babel/cli":"^7.21.5","@babel/core":"^7.21.8","@babel/eslint-parser":"^7.21.8","@babel/node":"^7.20.7","@babel/preset-env":"^7.21.5","@babel/register":"^7.21.0","@stryker-mutator/core":"^6.4.2","@stryker-mutator/mocha-runner":"^6.4.2","babel-loader":"^9.1.2",chai:"^4.3.6","core-js-pure":"^3.30.2",coveralls:"^3.1.1",eslint:"^8.41.0","eslint-webpack-plugin":"^4.0.1","json-loader":"^0.5.7",mocha:"^10.2.0","mocha-lcov-reporter":"^1.3.0",nyc:"^15.1.0",rimraf:"^5.0.1","standard-version":"^9.5.0","stryker-cli":"^1.0.2",webpack:"^5.83.1","webpack-cli":"^5.1.1"},dependencies:{ajv:"^8.12.0","ajv-draft-04":"^1.0.0","ajv-formats":"^2.1.1",commander:"^6.2.1",errno:"^1.0.0",glob:"^8.1.0","json-pointer":"^0.6.2","json-schema-ref-parser":"^9.0.9","jsonpath-plus":"^7.2.0","lodash.clonedeep":"^4.5.0","lodash.flatmap":"^4.5.0","lodash.flatten":"^4.4.0","lodash.merge":"^4.6.2",yaml:"^2.2.2"}}},643:e=>{"use strict";e.exports=require("ajv-draft-04")},638:e=>{"use strict";e.exports=require("ajv-formats")},304:e=>{"use strict";e.exports=require("commander")},373:e=>{"use strict";e.exports=require("errno")},230:e=>{"use strict";e.exports=require("glob")},125:e=>{"use strict";e.exports=require("json-pointer")},432:e=>{"use strict";e.exports=require("json-schema-ref-parser")},166:e=>{"use strict";e.exports=require("jsonpath-plus")},548:e=>{"use strict";e.exports=require("lodash.clonedeep")},574:e=>{"use strict";e.exports=require("lodash.flatmap")},760:e=>{"use strict";e.exports=require("lodash.flatten")},981:e=>{"use strict";e.exports=require("lodash.merge")},66:e=>{"use strict";e.exports=require("yaml")},147:e=>{"use strict";e.exports=require("fs")},17:e=>{"use strict";e.exports=require("path")}},t={},r=function r(a){var o=t[a];if(void 0!==o)return o.exports;var s=t[a]={exports:{}};return e[a](s,s.exports,r),s.exports}(339);module.exports=r})();
//# sourceMappingURL=cli.js.map